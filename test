# Import the required Active Directory module
Import-Module ActiveDirectory

# Define the top-level group
$topLevelGroup = "SDT_LIC_EXT_GEN"

# Prepare a list to store the extracted information
$userList = New-Object System.Collections.Generic.List[Object]

# Function to process a group and its members
function Process-Group {
    param (
        [string]$groupName
    )
    
    # Get the group and check if it exists
    $group = Get-ADGroup -Identity $groupName -ErrorAction SilentlyContinue
    if ($null -eq $group) {
        Write-Host "The group $groupName does not exist or cannot be found." -ForegroundColor Red
        return
    }

    # Get all nested groups underneath the top-level group
    $nestedGroups = Get-ADGroup -Identity $groupName -Properties Member | Select-Object -ExpandProperty Member -ErrorAction SilentlyContinue | ForEach-Object {
        Get-ADGroup -Identity $_ -Properties Name -ErrorAction SilentlyContinue | Where-Object { $_.Name -like "SDT_LIC_EXT_GEN_*" }
    }

    # Process each nested group
    foreach ($nestedGroup in $nestedGroups) {
        if ($null -eq $nestedGroup) {
            Write-Host "A nested group could not be found or accessed." -ForegroundColor Yellow
            continue
        }

        # Get all users in the nested group
        $users = Get-ADGroupMember -Identity $nestedGroup.DistinguishedName -ErrorAction SilentlyContinue | Where-Object { $_.objectClass -eq "user" }
        
        foreach ($user in $users) {
            if ($null -eq $user) {
                Write-Host "A user could not be found or accessed in group $($nestedGroup.Name)." -ForegroundColor Yellow
                continue
            }

            # Get detailed user information
            $userDetails = Get-ADUser -Identity $user.SamAccountName -Properties EmailAddress -ErrorAction SilentlyContinue
            if ($null -eq $userDetails) {
                Write-Host "Could not retrieve details for user $($user.SamAccountName)." -ForegroundColor Yellow
                continue
            }

            # Create an entry for each user and add to the list
            $userList.Add([PSCustomObject]@{
                Group = $nestedGroup.Name
                User = $userDetails.SamAccountName
                Email = $userDetails.EmailAddress
                ID = $userDetails.ObjectGUID
            })
        }
    }
}

# Process the top-level group
Process-Group -groupName $topLevelGroup

# Export the results to a CSV file, grouping users by their groups
$csvFilePath = "C:\path\to\your\directory\AD_User_Extract.csv"
$userList | Sort-Object Group | Export-Csv -Path $csvFilePath -NoTypeInformation -Encoding UTF8

Write-Host "The CSV file has been created at: $csvFilePath"
