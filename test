# Set TLS version
[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12

# Define variables
$JiraBaseURL = "https://your-jira-instance.atlassian.net"
$Username = "your-username"  # Replace with your Jira username (usually your email)
$ApiToken = "your-api-token"  # Replace with a valid Jira API token
$NoncompliantProjects = @("PROJECT1", "PROJECT2")
$ReadOnlyPermissionSchemeId = 10001  # Replace with your Read-Only Permission Scheme ID
$OriginalPermissionSchemeId = 10000  # Replace with your Original Permission Scheme ID

# Convert credentials to Base64
$AuthInfo = [Convert]::ToBase64String([Text.Encoding]::ASCII.GetBytes("$($Username):$($ApiToken)"))

# Function to switch permission scheme for a Jira project
function Set-JiraProjectPermissionScheme {
    param (
        [string]$ProjectKey,
        [int]$PermissionSchemeId
    )

    $Uri = "$JiraBaseURL/rest/api/2/project/$ProjectKey/permissionscheme"
    $Body = @{
        id = $PermissionSchemeId
    } | ConvertTo-Json

    $Headers = @{
        Authorization = "Basic $AuthInfo"
        "Content-Type"  = "application/json"
    }

    Write-Host "Sending request to $Uri..."
    
    try {
        $response = Invoke-RestMethod -Uri $Uri -Method PUT -Headers $Headers -Body $Body -ErrorAction Stop
        Write-Host "Successfully updated permission scheme for project $ProjectKey to scheme ID $PermissionSchemeId."
    } catch {
        Write-Host "Failed to update permission scheme for project $ProjectKey. Error: $_"
        if ($_.Exception.Response) {
            $respStream = $_.Exception.Response.GetResponseStream()
            $reader = New-Object System.IO.StreamReader($respStream)
            $reader.BaseStream.Position = 0
            $responseBody = $reader.ReadToEnd()
            Write-Host "Response from server: $responseBody"
        }
    }
}

# Step 1: Set noncompliant projects to read-only
foreach ($project in $NoncompliantProjects) {
    Set-JiraProjectPermissionScheme -ProjectKey $project -PermissionSchemeId $ReadOnlyPermissionSchemeId
}

# ----- Run the following step to restore the original permissions -----
# Step 2: Restore original permissions (Uncomment and run when needed)
# foreach ($project in $NoncompliantProjects) {
#     Set-JiraProjectPermissionScheme -ProjectKey $project -PermissionSchemeId $OriginalPermissionSchemeId
# }
