# Set TLS version
[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12

# Define variables
$JiraBaseURL = "https://your-jira-instance.atlassian.net"
$Username = "your-username"
$ApiToken = "your-api-token"
$NoncompliantProjects = @("PROJECT1", "PROJECT2")
$ReadOnlyPermissionSchemeId = 10001
$OriginalPermissionSchemeId = 10000

# Convert credentials to Base64
$AuthInfo = [Convert]::ToBase64String([Text.Encoding]::ASCII.GetBytes("$($Username):$($ApiToken)"))

# Function to switch permission scheme for a Jira project
function Set-JiraProjectPermissionScheme {
    param (
        [string]$ProjectKey,
        [int]$PermissionSchemeId
    )

    $Uri = "$JiraBaseURL/rest/api/2/project/$ProjectKey/permissionscheme"
    $Body = @{
        id = $PermissionSchemeId
    } | ConvertTo-Json

    $Headers = @{
        Authorization = "Basic $AuthInfo"
        "Content-Type"  = "application/json"
    }

    # Set timeout and other connection properties
    [System.Net.ServicePointManager]::FindServicePoint($Uri).ConnectionLeaseTimeout = 60000  # 60 seconds
    [System.Net.ServicePointManager]::FindServicePoint($Uri).Expect100Continue = $false

    try {
        Invoke-RestMethod -Uri $Uri -Method PUT -Headers $Headers -Body $Body
        Write-Host "Successfully updated permission scheme for project $ProjectKey to scheme ID $PermissionSchemeId."
    } catch {
        Write-Host "Failed to update permission scheme for project $ProjectKey. Error: $_"
    }
}

# Step 1: Set noncompliant projects to read-only
foreach ($project in $NoncompliantProjects) {
    Set-JiraProjectPermissionScheme -ProjectKey $project -PermissionSchemeId $ReadOnlyPermissionSchemeId
}

# ----- Run the following step to restore the original permissions -----
# Step 2: Restore original permissions (Uncomment and run when needed)
# foreach ($project in $NoncompliantProjects) {
#     Set-JiraProjectPermissionScheme -ProjectKey $project -PermissionSchemeId $OriginalPermissionSchemeId
# }
