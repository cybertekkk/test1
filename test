# Import the required modules
Import-Module ActiveDirectory
Import-Module ImportExcel

# Define the top-level groups
$topLevelGroups = @("SDT_LIC_EXT_GEN", "SDT_LIC_EXT_DEV")

# Prepare a list to store the extracted information
$userList = @()

# Function to process each top-level group
function Process-TopLevelGroup {
    param (
        [string]$groupName
    )
    
    # Get all nested groups underneath the top-level group
    $nestedGroups = Get-ADGroup -Identity $groupName -Properties Member | Select-Object -ExpandProperty Member | ForEach-Object {
        Get-ADGroup -Identity $_ -Properties Name | Where-Object { $_.Name -like "SDT_LIC_EXT_*_user" }
    }
    
    # Process each nested group
    foreach ($group in $nestedGroups) {
        $program = $group.Name -replace "SDT_LIC_EXT_(GEN|DEV)_", "" -replace "_user", ""
        
        # Get all users in the nested group
        $users = Get-ADGroupMember -Identity $group.DistinguishedName | Where-Object { $_.objectClass -eq "user" }
        
        foreach ($user in $users) {
            # Get detailed user information
            $userDetails = Get-ADUser -Identity $user.SamAccountName -Properties EmailAddress
            
            # Create an entry for each user
            $userList += [PSCustomObject]@{
                Program = $program
                User = $userDetails.SamAccountName
                Email = $userDetails.EmailAddress
                ID = $userDetails.ObjectGUID
            }
        }
    }
}

# Process each top-level group
foreach ($group in $topLevelGroups) {
    Process-TopLevelGroup -groupName $group
}

# Export the results to an Excel file
$excelFilePath = "C:\path\to\your\directory\AD_User_Extract.xlsx"
$userList | Export-Excel -Path $excelFilePath -AutoSize -Title "AD User Extract"

Write-Host "The Excel file has been created at: $excelFilePath"
